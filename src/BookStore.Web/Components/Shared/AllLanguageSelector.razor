@using System.Globalization
@inject LanguageService LanguageService

<MudAutocomplete T="string"
                 Label="@Label"
                 Value="@Value"
                 ValueChanged="@OnValueChangedInternal"
                 SearchFunc="@SearchLanguages"
                 ToStringFunc="@GetDisplayText"
                 Variant="@Variant"
                 Dense="@Dense"
                 Margin="@Margin"
                 Style="@Style"
                 Required="@Required"
                 Disabled="@Disabled"
                 Clearable="true"
                 AdornmentIcon="@Icons.Material.Filled.Language"
                 MaxItems="100">
    <ItemTemplate Context="langCode">
        @{
            var (name, local, native) = _allLanguages.FirstOrDefault(l => l.Code == langCode);
        }
        <div class="d-flex flex-column">
            <MudText Typo="Typo.body1">@local</MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                @native (@langCode)
            </MudText>
        </div>
    </ItemTemplate>
</MudAutocomplete>

@code {
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public string Label { get; set; } = "Language";
    [Parameter] public Variant Variant { get; set; } = Variant.Outlined;
    [Parameter] public bool Dense { get; set; } = true;
    [Parameter] public Margin Margin { get; set; } = Margin.None;
    [Parameter] public string? Style { get; set; }
    [Parameter] public bool Required { get; set; }
    [Parameter] public bool Disabled { get; set; }

    private List<(string Code, string LocalName, string NativeName)> _allLanguages = new();

    protected override void OnInitialized()
    {
        _allLanguages = LanguageService.GetAllLanguages().ToList();
    }

    private async Task OnValueChangedInternal(string value)
    {
        await ValueChanged.InvokeAsync(value);
    }

    private Task<IEnumerable<string>> SearchLanguages(string value, CancellationToken ct)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_allLanguages.Select(l => l.Code));

        var result = _allLanguages
            .Where(l => l.LocalName.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                        l.NativeName.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                        l.Code.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Select(l => l.Code);

        return Task.FromResult(result);
    }

    private string GetDisplayText(string langCode)
    {
        var lang = _allLanguages.FirstOrDefault(l => l.Code == langCode);
        return string.IsNullOrEmpty(lang.Code) ? langCode : lang.LocalName;
    }

}
