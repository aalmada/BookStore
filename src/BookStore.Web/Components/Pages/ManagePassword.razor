@page "/account/password"
@using Microsoft.AspNetCore.Authorization
@using BookStore.Web.Services
@using BookStore.Shared.Validation
@using BookStore.Web.Infrastructure
@inject AuthenticationService AuthService
@inject PasskeyService PasskeyService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject BookStore.Web.Services.ErrorLocalizationService ErrorLocalizer
@attribute [Authorize]

<PageTitle>Manage Password - BookStore</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Class="mr-2"/>
        Manage Password
    </MudText>

    @if (_hasPassword == null || _hasPasskeys == null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary"/>
    }
    else if (_hasPassword == false)
    {
        <MudAlert Severity="Severity.Info" Class="mb-4">
            You don't have a password set for your account. Set one now to have an alternative sign-in method.
        </MudAlert>

        <MudPaper Class="pa-4">
            <MudForm @ref="_form">
                <MudTextField @bind-Value="_newPassword"
                              Label="New Password"
                              InputType="@_newPasswordInput"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_newPasswordInputIcon"
                              OnAdornmentClick="@(() => ToggleVisibility(ref _showNewPassword, ref _newPasswordInput, ref _newPasswordInputIcon))"
                              Required="true"
                              RequiredError="Password is required"
                              OnBlur="ValidatePasswordStrength"
                              Class="mb-4"/>

                @if (_passwordErrors.Any())
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        <MudText Typo="Typo.body2" Class="mb-2">
                            <strong>Password must meet the following requirements:</strong>
                        </MudText>
                        <ul style="margin: 0; padding-left: 20px;">
                            @foreach (var error in _passwordErrors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </MudAlert>
                }

                <MudTextField @bind-Value="_confirmPassword"
                              Label="Confirm New Password"
                              InputType="@_confirmPasswordInput"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_confirmPasswordInputIcon"
                              OnAdornmentClick="@(() => ToggleVisibility(ref _showConfirmPassword, ref _confirmPasswordInput, ref _confirmPasswordInputIcon))"
                              Required="true"
                              RequiredError="Please confirm your password"
                              Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                              Class="mb-4"/>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="SetPassword"
                           Disabled="@(_isLoading || _passwordErrors.Any())"
                           FullWidth="true"
                           Size="Size.Large">
                    @(_isLoading ? "Setting Password..." : "Set Password")
                </MudButton>
            </MudForm>
        </MudPaper>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudForm @ref="_form">
                <MudTextField @bind-Value="_currentPassword"
                              Label="Current Password"
                              InputType="@_currentPasswordInput"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_currentPasswordInputIcon"
                              OnAdornmentClick="@(() => ToggleVisibility(ref _showCurrentPassword, ref _currentPasswordInput, ref _currentPasswordInputIcon))"
                              Required="true"
                              RequiredError="Current password is required"
                              Class="mb-4"/>

                <MudTextField @bind-Value="_newPassword"
                              Label="New Password"
                              InputType="@_newPasswordInput"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_newPasswordInputIcon"
                              OnAdornmentClick="@(() => ToggleVisibility(ref _showNewPassword, ref _newPasswordInput, ref _newPasswordInputIcon))"
                              Required="true"
                              RequiredError="New password is required"
                              Validation="@(new Func<string, string?>(ValidateNewPassword))"
                              OnBlur="ValidatePasswordStrength"
                              Class="mb-4"/>

                @if (_passwordErrors.Any())
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        <MudText Typo="Typo.body2" Class="mb-2">
                            <strong>Password must meet the following requirements:</strong>
                        </MudText>
                        <ul style="margin: 0; padding-left: 20px;">
                            @foreach (var error in _passwordErrors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </MudAlert>
                }

                <MudTextField @bind-Value="_confirmPassword"
                              Label="Confirm New Password"
                              InputType="@_confirmPasswordInput"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@_confirmPasswordInputIcon"
                              OnAdornmentClick="@(() => ToggleVisibility(ref _showConfirmPassword, ref _confirmPasswordInput, ref _confirmPasswordInputIcon))"
                              Required="true"
                              RequiredError="Please confirm your password"
                              Validation="@(new Func<string, string?>(ValidateConfirmPassword))"
                              Class="mb-4"/>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="ChangePassword"
                           Disabled="@(_isLoading || _passwordErrors.Any())"
                           FullWidth="true"
                           Size="Size.Large">
                    @(_isLoading ? "Changing Password..." : "Change Password")
                </MudButton>

                <MudDivider Class="my-6"/>

                <MudText Typo="Typo.h6" Class="mb-2">Danger Zone</MudText>

                @if (_hasPasskeys == true)
                {
                    <MudText Typo="Typo.body2" Class="mb-4">
                        If you have passkeys registered, you can remove your password to go passwordless.
                    </MudText>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               OnClick="RemovePassword"
                               Disabled="@_isLoading"
                               FullWidth="true">
                        Remove Password
                    </MudButton>
                }
                else
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-4">
                        You cannot remove your password because you don't have any passkeys registered.
                        Please <MudLink Href="/account/passkeys">add a passkey</MudLink> first to ensure you don't get locked out.
                    </MudAlert>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Error"
                               Disabled="true"
                               FullWidth="true">
                        Remove Password
                    </MudButton>
                }
            </MudForm>
        </MudPaper>
    }
</MudContainer>

@code {
    private MudForm? _form;
    private bool? _hasPassword;
    private bool? _hasPasskeys;
    private bool _isLoading;
    private string _currentPassword = "";
    private string _newPassword = "";
    private string _confirmPassword = "";
    private List<string> _passwordErrors = new();

    private bool _showCurrentPassword;
    private InputType _currentPasswordInput = InputType.Password;
    private string _currentPasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    private bool _showNewPassword;
    private InputType _newPasswordInput = InputType.Password;
    private string _newPasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    private bool _showConfirmPassword;
    private InputType _confirmPasswordInput = InputType.Password;
    private string _confirmPasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    protected override async Task OnInitializedAsync()
    {
        var authTask = AuthService.HasPasswordAsync();
        var passkeyTask = PasskeyService.ListPasskeysAsync();

        await Task.WhenAll(authTask, passkeyTask);

        _hasPassword = authTask.Result;
        _hasPasskeys = passkeyTask.Result.Any();
    }

    private void ToggleVisibility(ref bool show, ref InputType inputType, ref string icon)
    {
        if (show)
        {
            show = false;
            icon = Icons.Material.Filled.VisibilityOff;
            inputType = InputType.Password;
        }
        else
        {
            show = true;
            icon = Icons.Material.Filled.Visibility;
            inputType = InputType.Text;
        }
    }

    private void ValidatePasswordStrength()
    {
        var (_, errors) = PasswordValidator.Validate(_newPassword);
        _passwordErrors = errors.ToList();

        if (_hasPassword == true && !string.IsNullOrEmpty(_currentPassword) && _newPassword == _currentPassword)
        {
            _passwordErrors.Add("New password cannot be the same as the current password.");
        }
    }

    private async Task SetPassword()
    {
        if (_form == null) return;
        await _form.Validate();
        ValidatePasswordStrength();
        if (!_form.IsValid || _passwordErrors.Any()) return;

        _isLoading = true;
        try
        {
            var result = await AuthService.AddPasswordAsync(_newPassword);
            if (result.IsSuccess)
            {
                Snackbar.Add("Password set successfully!", Severity.Success);
                _hasPassword = true;
                _newPassword = "";
                _confirmPassword = "";
                _passwordErrors.Clear();
            }
            else
            {
                Snackbar.Add(ErrorLocalizer.GetLocalizedMessage(result.Error) ?? "Failed to set password.", Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ChangePassword()
    {
        if (_form == null) return;
        await _form.Validate();
        ValidatePasswordStrength();
        if (!_form.IsValid || _passwordErrors.Any()) return;

        _isLoading = true;
        try
        {
            var result = await AuthService.ChangePasswordAsync(_currentPassword, _newPassword);
            if (result.IsSuccess)
            {
                Snackbar.Add("Password changed successfully!", Severity.Success);
                _currentPassword = "";
                _newPassword = "";
                _confirmPassword = "";
                _passwordErrors.Clear();
            }
            else
            {
                Snackbar.Add(ErrorLocalizer.GetLocalizedMessage(result.Error) ?? "Failed to change password.", Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private string? ValidateConfirmPassword(string confirmPassword)
    {
        if (confirmPassword != _newPassword)
        {
            return "Passwords do not match";
        }

        return null;
    }

    private string? ValidateNewPassword(string newPassword)
    {
        if (_hasPassword == true && !string.IsNullOrEmpty(_currentPassword) && newPassword == _currentPassword)
        {
            return "New password cannot be the same as the current password.";
        }

        return null;
    }

    private async Task RemovePassword()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var confirmed = await DialogService.ShowMessageBox(
            "Remove Password",
            "Are you sure you want to remove your password? You will only be able to sign in using your passkeys.",
            yesText: "Remove Password", cancelText: "Cancel");

        if (confirmed != true) return;

        _isLoading = true;
        try
        {
            var result = await AuthService.RemovePasswordAsync();
            if (result.IsSuccess)
            {
                Snackbar.Add("Password removed successfully.", Severity.Success);
                _hasPassword = false;
                _currentPassword = "";
                _newPassword = "";
                _confirmPassword = "";
            }
            else
            {
                Snackbar.Add(ErrorLocalizer.GetLocalizedMessage(result.Error) ?? "Failed to remove password.", Severity.Error);
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

}
