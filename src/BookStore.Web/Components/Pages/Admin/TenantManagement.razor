@page "/admin/tenants"
@using BookStore.Client
@using Microsoft.AspNetCore.Authorization
@using BookStore.Shared.Models
@using BookStore.Shared.Notifications
@using BookStore.Shared.Validation
@using BookStore.Web.Infrastructure
@implements IDisposable
@inject ITenantsClient TenantClient
@inject TenantService TenantService
@inject ISnackbar Snackbar
@inject BookStoreEventsService EventsService
@inject QueryInvalidationService InvalidationService
@inject ILogger<TenantManagement> Logger
@inject BookStore.Web.Services.ErrorLocalizationService ErrorLocalizer
@attribute [Authorize(Policy = "SystemAdmin")]

<PageTitle>Tenant Management - BookStore</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" GutterBottom="true">Tenant Management</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateDialog" StartIcon="@Icons.Material.Filled.Add">
            Create New Tenant
        </MudButton>
    </MudPaper>

    <MudTable Items="@_tenants" Loading="@_isLoading" Hover="true" Breakpoint="Breakpoint.Sm" Elevation="4">
        <HeaderContent>
            <MudTh>ID</MudTh>
            <MudTh>Name / Tagline</MudTh>
            <MudTh>Theme</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="ID">@context.Id</MudTd>
            <MudTd DataLabel="Name / Tagline">
                <MudText Typo="Typo.body1">@context.Name</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">@context.Tagline</MudText>
            </MudTd>
            <MudTd DataLabel="Theme">
                <div style='@($"width: 24px; height: 24px; border-radius: 50%; background-color: {context.ThemePrimaryColor ?? "#594AE2"}; border: 1px solid #ccc;")'></div>
            </MudTd>
            <MudTd DataLabel="Status">
                <MudChip T="string" Color="@(context.IsEnabled ? Color.Success : Color.Error)" Size="Size.Small">
                    @(context.IsEnabled ? "Enabled" : "Disabled")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Info" OnClick="@(() => OpenEditDialog(context))"/>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

<MudDialog @bind-Visible="_isDialogVisible" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            @(_isEditing ? "Edit Tenant" : "Create Tenant")
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form">
            <MudStack Spacing="4" Class="mt-2">
                <MudTextField T="string" Value="_model.Id" Label="Tenant ID" Required="true"
                              Disabled="_isEditing" HelperText="A unique identifier for the tenant"
                              Immediate="true" ValueChanged="OnIdChanged"
                              Validation="@(new Func<string, string?>(ValidateTenantId))"/>

                @if (_idErrors.Any() && !_isEditing)
                {
                    <MudAlert Severity="Severity.Warning" Dense="true">
                        <MudText Typo="Typo.body2">
                            <strong>ID requirements:</strong>
                        </MudText>
                        <ul style="margin: 0; padding-left: 20px;">
                            @foreach (var error in _idErrors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </MudAlert>
                }

                <MudTextField @bind-Value="_model.Name" Label="Tenant Name" Required="true" HelperText="The display name for this tenant"/>
                <MudTextField @bind-Value="_model.Tagline" Label="Tagline" HelperText="A catchy tagline for the tenant's homepage"/>

                <MudColorPicker @bind-Text="_model.ThemePrimaryColor" Label="Primary Color" ColorPickerView="ColorPickerView.Palette" HelperText="Main color used for branding and themes"/>
                <MudCheckBox @bind-Value="_model.IsEnabled" Label="Enabled" Color="Color.Primary" Dense="true"/>

                @if (!_isEditing)
                {
                    <MudDivider Class="my-2"/>
                    <MudText Typo="Typo.subtitle1">Initial Admin User</MudText>
                    <MudTextField @bind-Value="_model.AdminEmail" Label="Admin Email"
                                  InputType="InputType.Email"
                                  Immediate="true"
                                  Validation="@(new Func<string, string?>(ValidateEmail))"
                                  HelperText="The email address for the initial tenant admin"/>

                    <MudTextField Value="_model.AdminPassword" Label="Admin Password"
                                  T="string"
                                  InputType="@(_passwordVisibility ? InputType.Text : InputType.Password)"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@(_passwordVisibility ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                  OnAdornmentClick="TogglePasswordVisibility"
                                  Immediate="true"
                                  ValueChanged="OnPasswordChanged"
                                  Validation="@(new Func<string, string?>(ValidatePassword))"
                                  HelperText="The password for the initial tenant admin"/>

                    @if (_passwordErrors.Any())
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                            <MudText Typo="Typo.body2">
                                <strong>Password requirements:</strong>
                            </MudText>
                            <ul style="margin: 0; padding-left: 20px;">
                                @foreach (var error in _passwordErrors)
                                {
                                    <li>@error</li>
                                }
                            </ul>
                        </MudAlert>
                    }
                }
            </MudStack>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit">@(_isEditing ? "Update" : "Create")</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<TenantInfoDto> _tenants = new();
    private bool _isLoading = true;
    private bool _isDialogVisible;
    private bool _isEditing;
    private TenantModel _model = new();
    private List<string> _idErrors = new();
    private List<string> _passwordErrors = new();
    private bool _passwordVisibility;
    private MudForm? _form;
    private DialogOptions _dialogOptions = new() { MaxWidth = MaxWidth.Small, FullWidth = true };

    protected override async Task OnInitializedAsync()
    {
        await LoadTenantsAsync();
        EventsService.OnNotificationReceived += HandleNotification;
    }

    public void Dispose()
    {
        EventsService.OnNotificationReceived -= HandleNotification;
    }

    private async void HandleNotification(IDomainEventNotification notification)
    {
        try
        {
            if (notification is PingNotification)
            {
                Logger.LogTrace("SSE Heartbeat (Ping) received.");
                return;
            }

            Logger.LogDebug("Received notification: {EventType} for {EntityId}", notification.EventType, notification.EntityId);

            if (InvalidationService.ShouldInvalidate(notification, ["Tenants"]))
            {
                Logger.LogInformation("Real-time update match for Tenants. Refreshing...");

                await InvokeAsync(async () =>
                {
                    Snackbar.Add("Real-time update received. Refreshing list...", Severity.Info);
                    await Task.Delay(1500); // Wait for projections to settle
                    await LoadTenantsAsync();
                    await TenantService.RefreshAvailableTenantsAsync();
                    StateHasChanged();
                });
            }
        }
        catch (OperationCanceledException)
        {
            Logger.LogDebug("TenantManagement notification update was canceled (likely navigation).");
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error processing real-time update for Tenants.");
        }
    }

    private async Task LoadTenantsAsync()
    {
        _isLoading = true;
        try
        {
            _tenants = await TenantClient.GetAllTenantsAdminAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load tenants: {ErrorLocalizer.GetLocalizedMessage(ex.Message)}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnIdChanged(string id)
    {
        _model.Id = id;
        var (_, errors) = TenantIdValidator.Validate(id);
        _idErrors = errors.ToList();
    }

    private void OnPasswordChanged(string password)
    {
        _model.AdminPassword = password;
        var (_, errors) = PasswordValidator.Validate(password);
        _passwordErrors = errors.ToList();
    }

    private void TogglePasswordVisibility()
    {
        _passwordVisibility = !_passwordVisibility;
    }

    private void OpenCreateDialog()
    {
        _isEditing = false;
        _model = new TenantModel { IsEnabled = true, ThemePrimaryColor = "#594AE2" };
        _idErrors = new();
        _passwordErrors = new();
        _passwordVisibility = false;
        _isDialogVisible = true;
    }

    private void OpenEditDialog(TenantInfoDto tenant)
    {
        _isEditing = true;
        _model = new TenantModel
        {
            Id = tenant.Id,
            Name = tenant.Name,
            Tagline = tenant.Tagline,
            ThemePrimaryColor = tenant.ThemePrimaryColor ?? "#594AE2",
            IsEnabled = tenant.IsEnabled,
            ETag = tenant.ETag
        };
        _isDialogVisible = true;
    }

    private void Cancel() => _isDialogVisible = false;

    private async Task Submit()
    {
        if (_form == null) return;
        await _form.Validate();
        if (!_form.IsValid) return;

        try
        {
            if (_isEditing)
            {
                await TenantClient.UpdateTenantAsync(_model.Id, new UpdateTenantCommand
                (
                    Name: _model.Name,
                    Tagline: _model.Tagline,
                    ThemePrimaryColor: _model.ThemePrimaryColor,
                    IsEnabled: _model.IsEnabled
                ), _model.ETag);
                Snackbar.Add("Tenant updated successfully", Severity.Success);
            }
            else
            {
                await TenantClient.CreateTenantAsync(new CreateTenantCommand
                (
                    Id: _model.Id,
                    Name: _model.Name,
                    Tagline: _model.Tagline,
                    ThemePrimaryColor: _model.ThemePrimaryColor,
                    IsEnabled: _model.IsEnabled,
                    AdminEmail: _model.AdminEmail,
                    AdminPassword: _model.AdminPassword
                ));
                Snackbar.Add("Tenant created successfully", Severity.Success);
            }

            _isDialogVisible = false;
            await LoadTenantsAsync();
            await TenantService.RefreshAvailableTenantsAsync();
        }
        catch (Refit.ApiException ex)
        {
            var result = ex.ToResult();
            Snackbar.Add($"Operation failed: {ErrorLocalizer.GetLocalizedMessage(result.Error)}", Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Operation failed: {ErrorLocalizer.GetLocalizedMessage(ex.Message)}", Severity.Error);
        }
    }

    private string? ValidateTenantId(string id)
    {
        return TenantIdValidator.GetFirstError(id);
    }

    private string? ValidateEmail(string? email)
    {
        return EmailValidator.GetError(email);
    }

    private string? ValidatePassword(string password)
    {
        return PasswordValidator.GetFirstError(password);
    }

    public class TenantModel
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string? Tagline { get; set; }
        public string? ThemePrimaryColor { get; set; }
        public bool IsEnabled { get; set; }
        public string? AdminEmail { get; set; }
        public string? AdminPassword { get; set; }
        public string? ETag { get; set; }
    }

}
