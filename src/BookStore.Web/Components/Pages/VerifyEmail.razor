@page "/verify-email"
@using BookStore.Web.Services
@inject AuthenticationService AuthService
@inject TenantService TenantService
@inject NavigationManager Navigation

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-8">
    <MudPaper Class="pa-8">
        <MudStack AlignItems="AlignItems.Center" Spacing="4">
            @if (_isLoading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true"/>
                <MudText>Verifying your email...</MudText>
            }
            else if (_isSuccess)
            {
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large"/>
                <MudText Typo="Typo.h5" Color="Color.Success">Email Verified!</MudText>
                <MudText>Your email has been successfully verified.</MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Navigation.NavigateTo("/login"))">Go to Login</MudButton>
            }
            else
            {
                <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Large"/>
                <MudText Typo="Typo.h5" Color="Color.Error">Verification Failed</MudText>
                <MudText>Invalid verification link or the link has expired.</MudText>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@(() => Navigation.NavigateTo("/"))">Go Home</MudButton>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromQuery] public string? UserId { get; set; }

    [SupplyParameterFromQuery] public string? Code { get; set; }

    [SupplyParameterFromQuery(Name = "tenant")] public string? TenantId { get; set; }

    private bool _isLoading = true;
    private bool _isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(UserId) || string.IsNullOrEmpty(Code))
        {
            _isLoading = false;
            _isSuccess = false;
            return;
        }

        if (!string.IsNullOrWhiteSpace(TenantId))
        {
            var tenantResult = await TenantService.SetTenantAsync(TenantId);
            if (tenantResult.IsFailure)
            {
                _isLoading = false;
                _isSuccess = false;
                return;
            }
        }

        // Delay slightly for UX/visual feedback
        await Task.Delay(500);

        var result = await AuthService.ConfirmEmailAsync(UserId, Code);
        _isSuccess = result.IsSuccess;
        _isLoading = false;
    }

}
