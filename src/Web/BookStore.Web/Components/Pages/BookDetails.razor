@page "/book/{id:guid}"
@using BookStore.Web.Services
@using BookStore.Client
@using ClientModels = BookStore.Client
@using BookStore.Shared.Models
@inject IGetBookEndpoint ApiClient
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>@(book?.Title ?? "Book Details") - BookStore</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    @if (isLoading)
    {
        <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 12px;">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
                </MudItem>
                <MudItem xs="12" md="8">
                    <MudSkeleton Width="60%" Height="60px" Class="mb-4" />
                    <MudSkeleton Width="40%" Class="mb-6" />
                    <MudSkeleton Width="100%" Height="200px" />
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else if (errorMessage != null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
            <MudText Typo="Typo.h6" Class="mb-2">@errorMessage</MudText>
            <MudButton OnClick="RetryLoad" Color="Color.Surface" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Refresh">
                Retry
            </MudButton>
        </MudAlert>
        <MudButton Href="/" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack">
            Back to Catalog
        </MudButton>
    }
    else if (book != null)
    {
        @* Breadcrumbs *@
        <MudBreadcrumbs Items="_breadcrumbItems" Class="mb-4" />

        <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 12px;">
            <MudGrid>
                @* Book Cover *@
                <MudItem xs="12" md="4">
                    <MudPaper Elevation="4" Style="border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 500px; display: flex; align-items: center; justify-content: center;">
                        <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Large" Color="Color.Surface" Style="font-size: 10rem;" />
                    </MudPaper>
                </MudItem>

                @* Book Information *@
                <MudItem xs="12" md="8">
                    <MudText Typo="Typo.h3" Class="mb-3">@book.Title</MudText>

                    @if (book.Authors.Count > 0)
                    {
                        <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" /> by @string.Join(", ", book.Authors.Select(a => a.Name))
                        </MudText>
                    }

                    @* Book Details Card *@
                    <MudCard Elevation="0" Class="mb-4" Style="background-color: rgba(0,0,0,0.02);">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-3">Book Information</MudText>
                            <MudStack Spacing="2">
                                @if (!string.IsNullOrWhiteSpace(book.Isbn))
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>ISBN:</strong> @book.Isbn</MudText>
                                    </MudStack>
                                }

                                @if (book.Publisher != null)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>Publisher:</strong> @book.Publisher.Name</MudText>
                                    </MudStack>
                                }

                                @if (!string.IsNullOrWhiteSpace(book.LanguageName))
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>Language:</strong> @book.LanguageName</MudText>
                                    </MudStack>
                                }

                                @if (book.PublicationDate.HasValue)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>Published:</strong> @book.PublicationDate.Value.ToDisplayString()</MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    @* Description *@
                    @if (!string.IsNullOrWhiteSpace(book.Description))
                    {
                        <MudCard Elevation="0" Style="background-color: rgba(0,0,0,0.02);">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Class="mb-3">Description</MudText>
                                <MudText Typo="Typo.body1">@book.Description</MudText>
                            </MudCardContent>
                        </MudCard>
                    }
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Actions *@
        <MudStack Row="true" Class="mt-6" Spacing="2">
            <MudButton Href="/" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack">
                Back to Catalog
            </MudButton>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private BookDto? book;
    private string? errorMessage;
    private bool isLoading = true;
    private List<BreadcrumbItem> _breadcrumbItems = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadBookAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload when ID parameter changes
        if (book?.Id != Id)
        {
            await LoadBookAsync();
        }
    }

    private async Task LoadBookAsync()
    {
        isLoading = true;
        errorMessage = null;
        book = null;

        try
        {
            book = await ApiClient.Execute(
                id: Id,
                api_version: "1.0",
                accept_Language: "en",
                x_Correlation_ID: Guid.NewGuid().ToString(),
                x_Causation_ID: string.Empty);
            
            // Update breadcrumbs
            _breadcrumbItems = new List<BreadcrumbItem>
            {
                new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
                new BreadcrumbItem(book.Title ?? "Book", href: null, disabled: true)
            };
        }
        catch (Refit.ApiException apiEx) when (apiEx.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            errorMessage = "Book not found. It may have been removed or the ID is incorrect.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load book details: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RetryLoad()
    {
        await LoadBookAsync();
    }
}
