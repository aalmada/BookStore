@page "/book/{id:guid}"
@using BookStore.Web.Services
@using BookStore.Client
@using ClientModels = BookStore.Client
@using BookStore.Shared.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject IBooksClient BooksClient
@inject IShoppingCartClient CartClient
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject ISnackbar Snackbar
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>@(book?.Title ?? "Book Details") - BookStore</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    @if (isLoading)
    {
        <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 12px;">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
                </MudItem>
                <MudItem xs="12" md="8">
                    <MudSkeleton Width="60%" Height="60px" Class="mb-4" />
                    <MudSkeleton Width="40%" Class="mb-6" />
                    <MudSkeleton Width="100%" Height="200px" />
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else if (errorMessage != null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
            <MudText Typo="Typo.h6" Class="mb-2">@errorMessage</MudText>
            <MudButton OnClick="RetryLoad" Color="Color.Surface" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Refresh">
                Retry
            </MudButton>
        </MudAlert>
        <MudButton Href="/" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack">
            Back to Catalog
        </MudButton>
    }
    else if (book != null)
    {
        @* Breadcrumbs *@
        <MudBreadcrumbs Items="_breadcrumbItems" Class="mb-4" />

        <MudPaper Elevation="2" Class="pa-6" Style="border-radius: 12px;">
            <MudGrid>
                @* Book Cover *@
                <MudItem xs="12" md="4">
                    @if (!string.IsNullOrEmpty(book.CoverImageUrl))
                    {
                        <MudImage Src="@book.CoverImageUrl" Alt="@book.Title" ObjectFit="ObjectFit.Cover" Elevation="4" Class="rounded-lg" Style="height: 500px; width: 100%;" />
                    }
                    else
                    {
                        <MudPaper Elevation="4" Style="border-radius: 12px; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 500px; display: flex; align-items: center; justify-content: center;">
                            <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Large" Color="Color.Surface" Style="font-size: 10rem;" />
                        </MudPaper>
                    }
                </MudItem>

                @* Book Information *@
                <MudItem xs="12" md="8">
                    <MudText Typo="Typo.h3" Class="mb-3">@book.Title</MudText>

                    @if (book.Authors.Count > 0)
                    {
                        <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-4">
                            <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" /> by @string.Join(", ", book.Authors.Select(a => a.Name))
                        </MudText>
                    }

                     @* Favorite Button *@
                     <AuthorizeView>
                        <Authorized>
                            <MudButton Variant="Variant.Outlined" 
                                       Color="@(book.IsFavorite ? Color.Error : Color.Default)"
                                       StartIcon="@(book.IsFavorite ? Icons.Material.Filled.Favorite : Icons.Material.Filled.FavoriteBorder)"
                                       OnClick="@(() => ToggleFavorite(book))"
                                       Class="mb-4">
                                @(book.IsFavorite ? "Remove from Favorites" : "Add to Favorites") (@book.LikeCount)
                            </MudButton>
                        </Authorized>
                     </AuthorizeView>

                     @* Rating *@
                     <AuthorizeView>
                        <Authorized>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                                <MudText Typo="Typo.body1" Class="mr-2">Your Rating:</MudText>
                                @for (int i = 1; i <= 5; i++)
                                {
                                    var starIndex = i;
                                    var isFilled = book.UserRating >= starIndex;
                                    <MudIconButton Icon="@(isFilled ? Icons.Material.Filled.Star : Icons.Material.Outlined.StarBorder)"
                                                   Color="@(isFilled ? Color.Warning : Color.Default)"
                                                   Size="Size.Large"
                                                   OnClick="@(() => RateBookAsync(starIndex))" />
                                }
                                @if (book.UserRating > 0)
                                {
                                    <MudTooltip Text="Clear rating">
                                        <MudIconButton Icon="@Icons.Material.Filled.Clear"
                                                       Color="Color.Default"
                                                       Size="Size.Small"
                                                       OnClick="@RemoveRatingAsync" />
                                    </MudTooltip>
                                }
                            </MudStack>
                            
                            @* Show average rating below user's rating *@
                            @if (book.RatingCount > 0)
                            {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">Average: </MudText>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var starIndex = i;
                                        var isFilled = book.AverageRating >= starIndex;
                                        var isHalfFilled = !isFilled && book.AverageRating >= starIndex - 0.5f;
                                        <MudIcon Icon="@(isFilled ? Icons.Material.Filled.Star : (isHalfFilled ? Icons.Material.Filled.StarHalf : Icons.Material.Outlined.StarBorder))"
                                                 Color="@(isFilled || isHalfFilled ? Color.Warning : Color.Default)"
                                                 Size="Size.Small" />
                                    }
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@book.AverageRating.ToString("F1") (@book.RatingCount @(book.RatingCount == 1 ? "rating" : "ratings"))</MudText>
                                </MudStack>
                            }
                        </Authorized>
                        <NotAuthorized>
                            @if (book.RatingCount > 0)
                            {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                                    <MudText Typo="Typo.body1" Class="mr-2">Average Rating:</MudText>
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        var starIndex = i;
                                        var isFilled = book.AverageRating >= starIndex;
                                        var isHalfFilled = !isFilled && book.AverageRating >= starIndex - 0.5f;
                                        <MudIcon Icon="@(isFilled ? Icons.Material.Filled.Star : (isHalfFilled ? Icons.Material.Filled.StarHalf : Icons.Material.Outlined.StarBorder))"
                                                 Color="@(isFilled || isHalfFilled ? Color.Warning : Color.Default)"
                                                 Size="Size.Large" />
                                    }
                                    <MudText Typo="Typo.body2" Class="ml-2">@book.AverageRating.ToString("F1") (@book.RatingCount @(book.RatingCount == 1 ? "rating" : "ratings"))</MudText>
                                </MudStack>
                            }
                        </NotAuthorized>
                     </AuthorizeView>

                     @* Add to Cart *@
                     <AuthorizeView>
                        <Authorized>
                            <MudPaper Elevation="0" Class="pa-4 mb-4" Style="background-color: rgba(0,0,0,0.02); border-radius: 8px;">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="4">
                                    <MudNumericField @bind-Value="quantity" Label="Quantity" Variant="Variant.Outlined" Min="1" Max="99" Class="mb-0" Style="max-width: 100px;" />
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary" 
                                               StartIcon="@Icons.Material.Filled.ShoppingCart"
                                               OnClick="AddToCartAsync"
                                               Size="Size.Large">
                                        Add to Cart
                                    </MudButton>
                                </MudStack>
                            </MudPaper>
                        </Authorized>
                        <NotAuthorized>
                             <MudAlert Severity="Severity.Info" Class="mb-4">Log in to add this book to your cart.</MudAlert>
                        </NotAuthorized>
                     </AuthorizeView>

                    @* Book Details Card *@
                    <MudCard Elevation="0" Class="mb-4" Style="background-color: rgba(0,0,0,0.02);">
                        <MudCardContent>
                            <MudText Typo="Typo.h6" Class="mb-3">Book Information</MudText>
                            <MudStack Spacing="2">
                                @if (!string.IsNullOrWhiteSpace(book.Isbn))
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>ISBN:</strong> @book.Isbn</MudText>
                                    </MudStack>
                                }

                                @if (book.Publisher != null)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>Publisher:</strong> @book.Publisher.Name</MudText>
                                    </MudStack>
                                }

                                @if (!string.IsNullOrWhiteSpace(book.LanguageName))
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.Language" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>Language:</strong> @book.LanguageName</MudText>
                                    </MudStack>
                                }

                                @if (book.PublicationDate.HasValue)
                                {
                                    <MudStack Row="true" AlignItems="AlignItems.Center">
                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" Color="Color.Secondary" />
                                        <MudText Typo="Typo.body2"><strong>Published:</strong> @book.PublicationDate.Value.ToDisplayString()</MudText>
                                    </MudStack>
                                }
                            </MudStack>
                        </MudCardContent>
                    </MudCard>

                    @* Description *@
                    @if (!string.IsNullOrWhiteSpace(book.Description))
                    {
                        <MudCard Elevation="0" Style="background-color: rgba(0,0,0,0.02);">
                            <MudCardContent>
                                <MudText Typo="Typo.h6" Class="mb-3">Description</MudText>
                                <MudText Typo="Typo.body1">@book.Description</MudText>
                            </MudCardContent>
                        </MudCard>
                    }
                </MudItem>
            </MudGrid>
        </MudPaper>

        @* Actions *@
        <MudStack Row="true" Class="mt-6" Spacing="2">
            <MudButton Href="/" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ArrowBack">
                Back to Catalog
            </MudButton>
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private ReactiveQuery<BookDto?>? bookQuery;
    private BookDto? book => bookQuery?.Data;
    private string? errorMessage => bookQuery?.Error;
    private bool isLoading => bookQuery?.IsLoading ?? true;
    private List<BreadcrumbItem> _breadcrumbItems = new();
    
    [Inject] private ILogger<BookDetails> Logger { get; set; } = default!;
    [Inject] private QueryInvalidationService InvalidationService { get; set; } = default!;
    
    [CascadingParameter] private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private System.Security.Claims.ClaimsPrincipal? user;
    private int quantity = 1;

    private async Task AddToCartAsync()
    {
        if (book == null) return;
        
        try
        {
            await CartClient.AddToCartAsync(new BookStore.Client.AddToCartClientRequest(book.Id, quantity));
            Snackbar.Add($"Added {quantity} copy(ies) to cart", Severity.Success);
            quantity = 1; // Reset quantity
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add book {BookId} to cart", book.Id);
            Snackbar.Add($"Failed to add to cart: {ex.Message}", Severity.Error);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Start SSE listening (ensure it's started if specific page loaded directly)
        EventsService.StartListening();
        
        await InitializeQueryAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload when ID parameter changes
        // Note: queryFn captures 'Id', so we need to reload if Id changes.
        // But ReactiveQuery caches the function. We strictly should allow updating the function or creating new query.
        // Easiest is to recreate the query if ID changes.
        if (bookQuery != null) // If checking existing query
        {
             // We can just rely on the fact that if OnParametersSetAsync runs, Id might have changed.
             // But we need to check if it actually changed to avoid loop?
             // Actually OnParametersSetAsync runs on standard parameter set.
             // We'll manage checking inside InitializeQueryAsync logic or just re-init.
             await InitializeQueryAsync();

        }

        var authState = await AuthStateTask;
        var newUser = authState.User;

        if (user == null || newUser.Identity?.Name != user.Identity?.Name || newUser.Identity?.IsAuthenticated != user.Identity?.IsAuthenticated)
        {
             user = newUser;
             if (user.Identity?.IsAuthenticated == true && bookQuery != null)
             {
                 await bookQuery.LoadAsync(silent: true);
             }
        }
    }

    private async Task InitializeQueryAsync()
    {
        // Dispose previous if exists
        bookQuery?.Dispose();

        bookQuery = new ReactiveQuery<BookDto?>(
            queryFn: async () => {
                try 
                {
                    return await BooksClient.GetBookAsync(
                        id: Id,
                        api_version: "1.0",
                        accept_Language: "en",
                        x_Correlation_ID: Guid.NewGuid().ToString(),
                        x_Causation_ID: string.Empty);
                }
                catch (Refit.ApiException apiEx) when (apiEx.StatusCode == System.Net.HttpStatusCode.NotFound)
                {
                    throw new Exception("Book not found. It may have been removed or the ID is incorrect.");
                }
            },
            eventsService: EventsService,
            invalidationService: InvalidationService,
            queryKeys: new[] { $"Book:{Id}", "User" },
            onStateChanged: StateHasChanged,
            logger: Logger
        );

        await bookQuery.LoadAsync();
        UpdateBreadcrumbs();
    }

    private async Task<BookDto?> FetchBookAsync()
    {
        try 
        {
            return await BooksClient.GetBookAsync(
                id: Id,
                api_version: "1.0",
                accept_Language: "en",
                x_Correlation_ID: Guid.NewGuid().ToString(),
                x_Causation_ID: string.Empty);
        }
        catch (Refit.ApiException apiEx) when (apiEx.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
             throw new Exception("Book not found. It may have been removed or the ID is incorrect.");
        }
    }

    private void UpdateBreadcrumbs()
    {
        if (book != null)
        {
            _breadcrumbItems = new List<BreadcrumbItem>
            {
                new BreadcrumbItem("Home", href: "/", icon: Icons.Material.Filled.Home),
                new BreadcrumbItem(book.Title ?? "Book", href: null, disabled: true)
            };
        }
    }

    private async Task RetryLoad()
    {
        if (bookQuery != null)
        {
            await bookQuery.LoadAsync();
            UpdateBreadcrumbs();
        }
    }

    private async Task ToggleFavorite(BookDto bookToToggle)
    {
        var originalState = bookToToggle.IsFavorite;

        // 1. Optimistic
        bookQuery?.MutateData(current => current == null ? null : current with 
        { 
            IsFavorite = !originalState,
            LikeCount = originalState ? current.LikeCount - 1 : current.LikeCount + 1
        });

        // 2. API Call
        try
        {
            if (originalState)
            {
                await BooksClient.RemoveBookFromFavoritesAsync(bookToToggle.Id);
                Snackbar.Add("Removed from favorites", Severity.Success);
            }
            else
            {
                await BooksClient.AddBookToFavoritesAsync(bookToToggle.Id);
                Snackbar.Add("Added to favorites", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to toggle favorite for book {BookId}", bookToToggle.Id);
            // 3. Rollback
            bookQuery?.MutateData(current => current == null ? null : current with 
            { 
                IsFavorite = originalState,
                LikeCount = originalState ? current.LikeCount + 1 : current.LikeCount - 1
            });
            Snackbar.Add($"Failed: {ex.Message}", Severity.Error);
        }
    }
    
    private async Task RateBookAsync(int rating)
    {
        if (book == null) return;

        var previousRating = book.UserRating;

        // 1. Optimistic update
        bookQuery?.MutateData(current => current == null ? null : current with
        {
            UserRating = rating
        });

        // 2. API Call
        try
        {
            await BooksClient.RateBookAsync(book.Id, new BookStore.Client.RateBookRequest(rating));
            Snackbar.Add($"Rated {rating} stars", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to rate book {BookId}", book.Id);
            // 3. Rollback
            bookQuery?.MutateData(current => current == null ? null : current with
            {
                UserRating = previousRating
            });
            Snackbar.Add($"Failed to rate: {ex.Message}", Severity.Error);
        }
    }

    private async Task RemoveRatingAsync()
    {
        if (book == null || book.UserRating == 0) return;

        var previousRating = book.UserRating;

        // 1. Optimistic update
        bookQuery?.MutateData(current => current == null ? null : current with
        {
            UserRating = 0
        });

        // 2. API Call
        try
        {
            await BooksClient.RemoveBookRatingAsync(book.Id);
            Snackbar.Add("Rating removed", Severity.Success);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to remove rating for book {BookId}", book.Id);
            // 3. Rollback
            bookQuery?.MutateData(current => current == null ? null : current with
            {
                UserRating = previousRating
            });
            Snackbar.Add($"Failed to remove rating: {ex.Message}", Severity.Error);
        }
    }

    // Inject EventsService which wasn't injected before
    [Inject] private BookStoreEventsService EventsService { get; set; } = default!;
    
    public async ValueTask DisposeAsync()
    {
        bookQuery?.Dispose();
    }
}
