# API Client Generation Guide

This guide explains how to use the BookStore API client library.

## Overview

The BookStore API client is provided as a reusable library (`BookStore.Client`) that can be used by any .NET project.

**Technology Stack**:
- **Refit**: Type-safe REST library
- **BookStore.Client**: Standalone client library
- **OpenAPI Spec**: Generated at runtime for documentation

## Using the Client Library

### Installation

Add a project reference to `BookStore.Client`:

```xml
<ProjectReference Include="path/to/BookStore.Client/BookStore.Client.csproj" />
```

### Registration

#### ASP.NET Core / Blazor

```csharp
using BookStore.Client;

var builder = WebApplication.CreateBuilder(args);

// Register the client
builder.Services
    .AddBookStoreClient(new Uri("https://api.bookstore.com"))
    .AddStandardResilienceHandler(); // Optional: Add Polly resilience

var app = builder.Build();
```

#### Console Application

```csharp
using BookStore.Client;
using Microsoft.Extensions.DependencyInjection;

var services = new ServiceCollection();
services.AddBookStoreClient(new Uri("https://api.bookstore.com"));

var provider = services.BuildServiceProvider();
var client = provider.GetRequiredService<IBookStoreApi>();

// Use the client
var books = await client.GetBooksAsync("clean code");
```

### Usage

Inject `IBookStoreApi` into your services:

```csharp
public class BookService
{
    private readonly IBookStoreApi _api;

    public BookService(IBookStoreApi api)
    {
        _api = api;
    }

    public async Task<PagedListDto<BookDto>> SearchBooksAsync(
        string? query = null,
        int page = 1,
        int pageSize = 20,
        CancellationToken cancellationToken = default)
    {
        return await _api.GetBooksAsync(query, page, pageSize, cancellationToken);
    }
}
```

## Available Endpoints

See `IBookStoreApi` for all available methods:

- **Books**: `GetBooksAsync`, `GetBookAsync`
- **Authors**: `GetAuthorsAsync`, `GetAuthorAsync`
- **Categories**: `GetCategoriesAsync`, `GetCategoryAsync`
- **Publishers**: `GetPublishersAsync`, `GetPublisherAsync`

## Resilience (Optional)

Add Polly resilience policies:

```csharp
// Standard resilience (recommended)
builder.Services
    .AddBookStoreClient(apiUrl)
    .AddStandardResilienceHandler();

// Custom Polly policies
builder.Services
    .AddBookStoreClient(apiUrl)
    .AddPolicyHandler(retryPolicy)
    .AddPolicyHandler(circuitBreakerPolicy);
```

## Maintaining the Client

### When API Changes

1. **Update OpenAPI Spec**:
   ```bash
   ./_tools/update-openapi.sh
   ```

2. **Update `IBookStoreApi.cs`** if endpoints changed:
   - Location: `src/Client/BookStore.Client/IBookStoreApi.cs`
   - Add/update methods to match API changes

3. **Build and Test**:
   ```bash
   dotnet build
   dotnet test
   ```

4. **Commit Changes**:
   ```bash
   git add openapi.json src/Client/BookStore.Client/IBookStoreApi.cs
   git commit -m "Update API client: [description]"
   ```

### Update Script

The `update-openapi.sh` script:
- Auto-detects Aspire's dynamic ports
- Downloads the OpenAPI spec
- Validates the file

## OpenAPI Specification

**Location**: `openapi.json` (repository root)

**Purpose**:
- API contract documentation
- Scalar UI documentation (`/scalar/v1`)
- Contract validation
- Manual client updates

**Format**: OpenAPI 3.1.1 (generated by .NET 9)

## References

- [Refit Documentation](https://github.com/reactiveui/refit)
- [OpenAPI 3.1 Specification](https://spec.openapis.org/oas/v3.1.0)
- [Client Library README](../src/Client/BookStore.Client/README.md)
